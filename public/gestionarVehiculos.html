<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLI-CAR Nuevo - Gestionar Veh√≠culos</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container">
    <h1>üöó Gesti√≥n de Veh√≠culos</h1>
    <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
        üìç Sede actual: <strong id="sede-actual">Central</strong> | 
        Datos replicados en todas las sedes
    </p>
    
    <div class="section-actions">
        <button class="btn btn-primary" onclick="mostrarFormularioAgregar()">
            ‚ûï Nuevo Veh√≠culo
        </button>
        <button class="btn btn-secondary" onclick="cargarVehiculos()">
            üîÑ Actualizar Lista
        </button>
        <button class="btn btn-secondary" onclick="location.href='dashboard.html'">
            ‚Üê Volver al Dashboard
        </button>
    </div>
    
    <!-- Formulario para agregar/editar veh√≠culo -->
    <div id="formularioVehiculo" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h3 id="tituloFormulario">Nuevo Veh√≠culo</h3>
        <form id="vehiculoForm">
            <div class="form-group">
                <label>Placa:</label>
                <input type="text" id="vehiculoPlaca" required maxlength="10" placeholder="ABC1234" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>C√©dula del Cliente:</label>
                <input type="text" id="vehiculoCedula" required maxlength="10" placeholder="1234567890">
            </div>
            <div class="form-group">
                <label>Marca:</label>
                <input type="text" id="vehiculoMarca" required placeholder="Toyota, Chevrolet, Nissan, etc.">
            </div>
            <div class="form-group">
                <label>Modelo:</label>
                <input type="text" id="vehiculoModelo" required placeholder="Corolla, Sail, Sentra, etc.">
            </div>
            <div class="form-group">
                <label>A√±o:</label>
                <input type="number" id="vehiculoA√±o" required min="1950" max="2025" placeholder="2020">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-success">üíæ Guardar</button>
                <button type="button" class="btn btn-secondary" onclick="cancelarFormulario()">‚ùå Cancelar</button>
            </div>
        </form>
    </div>
    
    <div class="table-container">
        <table id="vehiculosTable" class="data-table">
            <thead>
                <tr>
                    <th>Placa</th>
                    <th>Cliente</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>A√±o</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6" class="loading">Cargando veh√≠culos...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
// Variables globales
let modoEdicion = false;
let placaOriginal = '';

// Inicializar p√°gina
document.addEventListener('DOMContentLoaded', function() {
    const sedeActual = localStorage.getItem('sedeSeleccionada') || 'Central';
    document.getElementById('sede-actual').textContent = sedeActual;
    
    cargarVehiculos();
    
    // Event listener para el formulario
    document.getElementById('vehiculoForm').addEventListener('submit', guardarVehiculo);
    
    // Convertir placa a may√∫sculas mientras se escribe
    document.getElementById('vehiculoPlaca').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
});

// Cargar lista de veh√≠culos
async function cargarVehiculos() {
    try {
        const tbody = document.querySelector('#vehiculosTable tbody');
        tbody.innerHTML = '<tr><td colspan="6" class="loading">Cargando veh√≠culos...</td></tr>';
        
        const response = await fetch('/api/vehiculos');
        const data = await response.json();
        
        if (data.success) {
            mostrarVehiculosTabla(data.data);
        } else {
            tbody.innerHTML = `<tr><td colspan="6" class="error-message">Error: ${data.message}</td></tr>`;
        }
    } catch (error) {
        console.error('Error:', error);
        const tbody = document.querySelector('#vehiculosTable tbody');
        tbody.innerHTML = '<tr><td colspan="6" class="error-message">Error de conexi√≥n</td></tr>';
    }
}

// Mostrar veh√≠culos en la tabla
function mostrarVehiculosTabla(vehiculos) {
    const tbody = document.querySelector('#vehiculosTable tbody');
    tbody.innerHTML = '';
    
    if (vehiculos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #7f8c8d;">No hay veh√≠culos registrados</td></tr>';
        return;
    }
    
    vehiculos.forEach(vehiculo => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${vehiculo.placa}</td>
            <td>${vehiculo.nombre_cliente} ${vehiculo.apellido_cliente}</td>
            <td>${vehiculo.marca}</td>
            <td>${vehiculo.modelo}</td>
            <td>${vehiculo.a√±o}</td>
            <td>
                <button class="btn btn-primary" onclick="editarVehiculo('${vehiculo.placa}', '${vehiculo.cedula_cliente}', '${vehiculo.marca}', '${vehiculo.modelo}', '${vehiculo.a√±o}')">‚úèÔ∏è Editar</button>
                <button class="btn btn-danger" onclick="eliminarVehiculo('${vehiculo.placa}')">üóëÔ∏è Eliminar</button>
            </td>
        `;
    });
}

// Mostrar formulario para agregar
function mostrarFormularioAgregar() {
    modoEdicion = false;
    placaOriginal = '';
    document.getElementById('tituloFormulario').textContent = 'Nuevo Veh√≠culo';
    document.getElementById('formularioVehiculo').style.display = 'block';
    
    // Limpiar formulario
    document.getElementById('vehiculoPlaca').value = '';
    document.getElementById('vehiculoCedula').value = '';
    document.getElementById('vehiculoMarca').value = '';
    document.getElementById('vehiculoModelo').value = '';
    document.getElementById('vehiculoA√±o').value = '';
    document.getElementById('vehiculoPlaca').disabled = false;
}

// Editar veh√≠culo
function editarVehiculo(placa, cedula, marca, modelo, a√±o) {
    modoEdicion = true;
    placaOriginal = placa;
    document.getElementById('tituloFormulario').textContent = 'Editar Veh√≠culo';
    document.getElementById('formularioVehiculo').style.display = 'block';
    
    // Llenar formulario
    document.getElementById('vehiculoPlaca').value = placa;
    document.getElementById('vehiculoCedula').value = cedula;
    document.getElementById('vehiculoMarca').value = marca;
    document.getElementById('vehiculoModelo').value = modelo;
    document.getElementById('vehiculoA√±o').value = a√±o;
    document.getElementById('vehiculoPlaca').disabled = true; // No permitir editar placa
}

// Guardar veh√≠culo (crear o actualizar)
async function guardarVehiculo(event) {
    event.preventDefault();
    
    const vehiculoData = {
        placa: document.getElementById('vehiculoPlaca').value.toUpperCase(),
        cedula_cliente: document.getElementById('vehiculoCedula').value,
        marca: document.getElementById('vehiculoMarca').value,
        modelo: document.getElementById('vehiculoModelo').value,
        a√±o: parseInt(document.getElementById('vehiculoA√±o').value)
    };
    
    try {
        let response;
        if (modoEdicion) {
            // Actualizar veh√≠culo existente
            response = await fetch(`/api/vehiculos/${placaOriginal}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(vehiculoData)
            });
        } else {
            // Crear nuevo veh√≠culo
            response = await fetch('/api/vehiculos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(vehiculoData)
            });
        }
        
        const data = await response.json();
        
        if (data.success) {
            mostrarExito(modoEdicion ? 'Veh√≠culo actualizado exitosamente' : 'Veh√≠culo creado exitosamente');
            cancelarFormulario();
            cargarVehiculos();
        } else {
            mostrarError('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('Error de conexi√≥n al guardar veh√≠culo');
    }
}

// Eliminar veh√≠culo
async function eliminarVehiculo(placa) {
    if (!confirm(`¬øEst√° seguro de eliminar el veh√≠culo con placa ${placa}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/vehiculos/${placa}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarExito('Veh√≠culo eliminado exitosamente');
            cargarVehiculos();
        } else {
            mostrarError('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('Error de conexi√≥n al eliminar veh√≠culo');
    }
}

// Cancelar formulario
function cancelarFormulario() {
    document.getElementById('formularioVehiculo').style.display = 'none';
    document.getElementById('vehiculoForm').reset();
}

// Funciones de utilidad
function mostrarError(mensaje) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = mensaje;
    
    const container = document.querySelector('.container');
    container.insertBefore(errorDiv, container.firstChild);
    
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

function mostrarExito(mensaje) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.textContent = mensaje;
    
    const container = document.querySelector('.container');
    container.insertBefore(successDiv, container.firstChild);
    
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}
</script>
</body>
</html>
